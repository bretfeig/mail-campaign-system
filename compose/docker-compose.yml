version: "3.9"

# All services bind to 127.0.0.1 to avoid external exposure during development.
services:
  postgres:
    image: postgres:16-alpine
    container_name: mail_postgres
    environment:
      POSTGRES_USER: listmonk
      POSTGRES_PASSWORD: listmonk
      POSTGRES_DB: listmonk
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U listmonk -d listmonk"]
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  listmonk:
    image: listmonk/listmonk:latest
    container_name: mail_listmonk
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "127.0.0.1:9100:9000" # Listmonk UI (local only, mapped to 9100 to avoid MinIO conflict)
    volumes:
      - ./listmonk-config.toml:/listmonk/config.toml
    restart: unless-stopped
    command: [sh, -c, "yes | ./listmonk --install --config /listmonk/config.toml && ./listmonk --config /listmonk/config.toml"]

  mailpit:
    image: axllent/mailpit:latest
    container_name: mail_mailpit
    environment:
      MP_MAX_MESSAGES: 100000
      MP_UI_AUTH: ""
    ports:
      - "127.0.0.1:1025:1025" # SMTP sink (local only)
      - "127.0.0.1:8025:8025" # Web UI (local only)
    restart: unless-stopped

  parser:
    build:
      context: ../services/parser
      dockerfile: Dockerfile
    container_name: mail_parser
    environment:
      MODE: ${MODE:-test}
      OUTPUT_CSV: /data/out/contacts.csv
      IMAP_HOST: ${IMAP_HOST:-}
      IMAP_PORT: ${IMAP_PORT:-993}
      IMAP_USER: ${IMAP_USER:-}
      IMAP_PASS: ${IMAP_PASS:-}
      IMAP_SSL: ${IMAP_SSL:-true}
      LLM_PROVIDER: ${LLM_PROVIDER:-none}
      LLM_MODEL: ${LLM_MODEL:-}
      LLM_API_KEY: ${LLM_API_KEY:-}
      LLM_ENDPOINT: ${LLM_ENDPOINT:-}
    volumes:
      - ../data:/data
    command: ["python", "-m", "app.main", "--scan-dir", "/data/samples", "--once"]
    restart: "no"

  metrics:
    build:
      context: ../services/metrics
      dockerfile: Dockerfile
    container_name: mail_metrics
    environment:
      CSV_PATH: /data/out/contacts.csv
      SCRAPE_INTERVAL: 5
    volumes:
      - ../data:/data
    ports:
      - "127.0.0.1:8000:8000" # Prometheus metrics endpoint (local only)
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.55.0
    container_name: mail_prometheus
    command: ["--config.file=/etc/prometheus/prometheus.yml","--storage.tsdb.path=/prometheus","--web.listen-address=0.0.0.0:9090"]
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "127.0.0.1:9090:9090"
    restart: unless-stopped
    depends_on:
      - metrics

  grafana:
    image: grafana/grafana:11.2.0
    container_name: mail_grafana
    environment:
      GF_SERVER_HTTP_ADDR: 0.0.0.0
      GF_SERVER_HTTP_PORT: 3000
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "127.0.0.1:3000:3000"
    restart: unless-stopped
    depends_on:
      - prometheus

volumes:
  postgres_data:
  listmonk_data:
  grafana_data:
